---
layout: post
title: Linux 免密登录原理及应用
categories: [linux]
tags: [linux]
fullview: false
comments: true
---

SSH 服务可以对所有传输的数据进行加密，提供比传统 telnet 服务更高的安全性。
而基于密钥认证的 SSH 自动化登录，在保障安全性的同时，可以简化登录过程，降低运维成本。
本文先简要介绍基于密钥交换的 SSH 自动登录的原理，然后对配置方法进行说明。

## 一， 原理简介
---
SSH证书认证登录的基础是一对唯一匹配密钥: 私钥（private key）和公钥（public key）。
公钥用于对数据进行加密，而且只能用于加密。而私钥只能对使用所匹配的公钥，所加密过的数据进行解密。
私钥需要用户单独妥善保管。SSH 客户端使用私钥向服务器证明自已的身份。而公钥是公开的，可以按需将其配置到目标服务器上自己的相应帐号中。

在进行 SSH 登录认证时，进行私钥和公钥协商。如果匹配，则身份得以证明，认证成功，允许登录。
否则，将会继续使用密码验证等其它方式进行登录校验。SSH 证书验证登录配置及登录协商过程，如下证书校验交互登录流程示意图所示：

![SSH 服务连接交互示意图 ](http://img.alicdn.com/tfscom/TB1A1DHJVXXXXXMXFXXXXXXXXXX.png)

## 二， 自动登录配置
---
```
SSH Client : 192.168.0.12 ( Fedora 21 )
SSH Remote Host : 192.168.0.11 ( CentOS 7 )
```

### 2.1 本地客户端生成密钥对
---
SSH 协议 V1只使用 RSA 算法，而 SSH 协议V2 对 RSA 算法和 DSA 算法都支持。
目前所有OpenSSH 版本都应该对两种算法都支持。两种算法的密钥的生成指令和使用方法相同，本文仅以 RSA 算法为例进行相关说明。

生成密钥对的时候，可以按需决定是否设置密码。但需要注意的是，如果设置了密码，还需结合 ssh-agent 代理和 ssh-add 配置才能实现自动登录。
同时，相关配置只对 ssh-agent 启动的相应 shell 生效，用户退出后重新登录时还需重新配置。所以，为简便起见，本文以常见的、不配置密码的情况进行说明。

在本地`192.168.0.12`生成密钥

```sh
[tecmint@tecmint.com ~]$ ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/home/tecmint/.ssh/id_rsa): [Press enter key]
Created directory '/home/tecmint/.ssh'.
Enter passphrase (empty for no passphrase): [Press enter key]
Enter same passphrase again: [Press enter key]
Your identification has been saved in /home/tecmint/.ssh/id_rsa.
Your public key has been saved in /home/tecmint/.ssh/id_rsa.pub.
The key fingerprint is:
5f:ad:40:00:8a:d1:9b:99:b3:b0:f8:08:99:c3:ed:d3 tecmint@tecmint.com
The key's randomart image is:
+--[ RSA 2048]----+
|        ..oooE.++|
|         o. o.o  |
|          ..   . |
|         o  . . o|
|        S .  . + |
|       . .    . o|
|      . o o    ..|
|       + +       |
|        +.       |
+-----------------+
```

### 2.2 登录远程服务器
---
使用用户名密码登录`192.168.0.11`, 创建`.ssh`文件夹
```sh
[tecmint@tecmint ~]$ ssh sheena@192.168.0.11 mkdir -p .ssh
The authenticity of host '192.168.0.11 (192.168.0.11)' can't be established.
RSA key fingerprint is 45:0e:28:11:d6:81:62:16:04:3f:db:38:02:la:22:4e.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.0.11' (ECDSA) to the list of known hosts.
sheena@192.168.0.11's password: [Enter Your Password Here]
```

### 2.3 上传公钥
---
```sh
[tecmint@tecmint ~]$ cat .ssh/id_rsa.pub | ssh sheena@192.168.0.11 'cat >> .ssh/authorized_keys'
sheena@192.168.1.2's password: [Enter Your Password Here]
```

### 2.4 修改服务器端`ssh`权限
---
```sh
[tecmint@tecmint ~]$ ssh sheena@192.168.0.11 "chmod 700 .ssh; chmod 640 .ssh/authorized_keys"
sheena@192.168.0.11's password: [Enter Your Password Here]
```

### 2.5 登录
---
```
[tecmint@tecmint ~]$ ssh sheena@192.168.0.11
```


## 3. 最后
---
如上这么多的操作， 其实就只是把客户端的`id_rsa`里面的内容复制到服务端`authorized_keys`。